import { Behaviour, GameObject, serializable, WebXR } from "@needle-tools/engine";
import { LookingGlassWebXRPolyfill, LookingGlassConfig } from "@lookingglass/webxr";

// Documentation â†’ https://docs.needle.tools/scripting

export class LookingGlass extends Behaviour {

    @serializable()
    public targetY : number = 0;
    @serializable()
    public trackballX : number = 0;
    @serializable()
    public trackballY : number = 0;
    @serializable()
    public targetDiam : number = 3;

    awake() {

        const btnGroup = document.createElement('div');
        btnGroup.style.display = 'flex';
        btnGroup.style.flexDirection = 'column';
        btnGroup.style.position = 'absolute';
        btnGroup.style.top = '10px';
        btnGroup.style.right = '10px';
        const btn = document.createElement('button');
        btn.innerHTML = "<p>Click to display on<p>";
        btn.style.backgroundColor = 'black';
        btn.style.color = 'white';
        btnGroup.appendChild(btn);

        btnGroup.appendChild(this.makeButton("Learn More", "https://look.glass"));
        btnGroup.appendChild(this.makeButton("Buy ($40 off)", "https://lookingglass.refr.cc/needle"));

        this.context.domElement.appendChild(btnGroup);

        const config = LookingGlassConfig;
        console.log(config)

        config.tileHeight = 512;
        config.numViews = 45;
        config.targetY = this.targetY;
        config.targetZ = 0;
        console.log(this.trackballX);
        config.trackballX = this.trackballX / 180.0 * Math.PI;
        config.trackballY = this.trackballY / 180.0 * Math.PI;
        config.targetDiam = this.targetDiam;
        config.fovy = (40 * Math.PI) / 180;
        config.depthiness = 1.0;

        const polyfill = new LookingGlassWebXRPolyfill(config);

        const webxr = GameObject.findObjectOfType(WebXR);
        if (!webxr) return;
        const startVR = WebXR.createVRButton(webxr);

        btn.addEventListener('click', () => {
            startVR?.click();
        });
        
        btn.appendChild(this.lookingGlassLogo());
    }

    private makeButton(text, url) {
        const learnMoreButton = document.createElement('button');
        learnMoreButton.style.backgroundColor = 'black';
        learnMoreButton.style.marginTop = '10px';
        learnMoreButton.style.paddingTop = '5px';
        learnMoreButton.style.paddingBottom = '5px';
        const learnMoreLink = document.createElement('a');
        learnMoreLink.style.color = 'white';
        learnMoreLink.text = text;
        learnMoreLink.href = url;
        learnMoreLink.target = "_blank";
        learnMoreButton.appendChild(learnMoreLink);
        return learnMoreButton;
    }

    private lookingGlassLogo() : HTMLImageElement {
        const logo = `
<svg width="90" height="58" viewBox="0 0 90 58" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M31.291 22.2457L33.2443 21.4246L44.8045 26.2997L56.3694 21.4246L58.3124 22.2457L44.8045 27.9429L31.291 22.2457Z" fill="url(#paint0_linear_414_27)"/>
<path d="M44.8046 17.7114L33.2453 22.5857L31.2892 21.7674L44.8046 16.0664L58.3124 21.7655L56.3695 22.5866L44.8046 17.7114Z" fill="url(#paint1_radial_414_27)"/>
<path d="M18.9369 27.9674V16.0327L44.812 4.51099L70.6871 16.0327V27.9674L44.812 39.4891L18.9369 27.9674ZM44.8129 37.831L68.0177 27.4983L54.9926 22.0052L68.029 16.5055L44.8129 6.16725L21.5425 16.5299L34.6258 22.0033L21.5978 27.4955L44.812 37.831H44.8129ZM69.1725 26.342V17.6674L58.885 22.0052L69.1725 26.342ZM20.4534 26.3354L30.7221 22.0052L20.4534 17.6759V26.3354Z" fill="#FAFAFA"/>
<path d="M0 53.9999V46.3219H1.232V52.9659H4.73V53.9999H0Z" fill="#FAFAFA"/>
<path d="M9.2077 54.1319C8.7237 54.1319 8.30204 54.0439 7.9427 53.8679C7.5907 53.6846 7.29737 53.4243 7.0627 53.0869C6.83537 52.7496 6.6667 52.3353 6.5567 51.8439C6.4467 51.3526 6.3917 50.7916 6.3917 50.1609C6.3917 49.5376 6.4467 48.9803 6.5567 48.4889C6.6667 47.9903 6.83537 47.5723 7.0627 47.2349C7.29737 46.8976 7.5907 46.6409 7.9427 46.4649C8.30204 46.2816 8.7237 46.1899 9.2077 46.1899C9.6917 46.1899 10.1097 46.2816 10.4617 46.4649C10.821 46.6409 11.1144 46.8976 11.3417 47.2349C11.5764 47.5723 11.7487 47.9903 11.8587 48.4889C11.9687 48.9803 12.0237 49.5376 12.0237 50.1609C12.0237 50.7916 11.9687 51.3526 11.8587 51.8439C11.7487 52.3353 11.5764 52.7496 11.3417 53.0869C11.1144 53.4243 10.821 53.6846 10.4617 53.8679C10.1097 54.0439 9.6917 54.1319 9.2077 54.1319ZM9.2077 53.1089C9.7577 53.1089 10.1464 52.9036 10.3737 52.4929C10.601 52.0749 10.7147 51.5103 10.7147 50.7989V49.5119C10.7147 48.8079 10.601 48.2506 10.3737 47.8399C10.1464 47.4219 9.7577 47.2129 9.2077 47.2129C8.6577 47.2129 8.26904 47.4219 8.0417 47.8399C7.81437 48.2506 7.7007 48.8079 7.7007 49.5119V50.8099C7.7007 51.5139 7.81437 52.0749 8.0417 52.4929C8.26904 52.9036 8.6577 53.1089 9.2077 53.1089Z" fill="#FAFAFA"/>
<path d="M16.3034 54.1319C15.8194 54.1319 15.3977 54.0439 15.0384 53.8679C14.6864 53.6846 14.3931 53.4243 14.1584 53.0869C13.9311 52.7496 13.7624 52.3353 13.6524 51.8439C13.5424 51.3526 13.4874 50.7916 13.4874 50.1609C13.4874 49.5376 13.5424 48.9803 13.6524 48.4889C13.7624 47.9903 13.9311 47.5723 14.1584 47.2349C14.3931 46.8976 14.6864 46.6409 15.0384 46.4649C15.3977 46.2816 15.8194 46.1899 16.3034 46.1899C16.7874 46.1899 17.2054 46.2816 17.5574 46.4649C17.9167 46.6409 18.2101 46.8976 18.4374 47.2349C18.6721 47.5723 18.8444 47.9903 18.9544 48.4889C19.0644 48.9803 19.1194 49.5376 19.1194 50.1609C19.1194 50.7916 19.0644 51.3526 18.9544 51.8439C18.8444 52.3353 18.6721 52.7496 18.4374 53.0869C18.2101 53.4243 17.9167 53.6846 17.5574 53.8679C17.2054 54.0439 16.7874 54.1319 16.3034 54.1319ZM16.3034 53.1089C16.8534 53.1089 17.2421 52.9036 17.4694 52.4929C17.6967 52.0749 17.8104 51.5103 17.8104 50.7989V49.5119C17.8104 48.8079 17.6967 48.2506 17.4694 47.8399C17.2421 47.4219 16.8534 47.2129 16.3034 47.2129C15.7534 47.2129 15.3647 47.4219 15.1374 47.8399C14.9101 48.2506 14.7964 48.8079 14.7964 49.5119V50.8099C14.7964 51.5139 14.9101 52.0749 15.1374 52.4929C15.3647 52.9036 15.7534 53.1089 16.3034 53.1089Z" fill="#FAFAFA"/>
<path d="M23.1131 50.4689L22.1891 51.6239V53.9999H20.9571V46.3219H22.1891V49.9959H22.2441L23.1791 48.7199L25.0601 46.3219H26.4791L23.9491 49.5559L26.5781 53.9999H25.1701L23.1131 50.4689Z" fill="#FAFAFA"/>
<path d="M28.0748 53.9999V53.0649H29.8788V47.2569H28.0748V46.3219H32.9148V47.2569H31.1108V53.0649H32.9148V53.9999H28.0748Z" fill="#FAFAFA"/>
<path d="M36.2595 48.0929H36.1605V53.9999H35.0825V46.3219H36.6665L38.9215 52.2289H39.0205V46.3219H40.0985V53.9999H38.5145L36.2595 48.0929Z" fill="#FAFAFA"/>
<path d="M46.1162 52.9439H46.0392C45.9732 53.0979 45.8926 53.2483 45.7972 53.3949C45.7092 53.5343 45.5956 53.6589 45.4562 53.7689C45.3242 53.8789 45.1629 53.9669 44.9722 54.0329C44.7816 54.0989 44.5616 54.1319 44.3122 54.1319C43.5129 54.1319 42.9116 53.7909 42.5082 53.1089C42.1049 52.4269 41.9032 51.4626 41.9032 50.2159C41.9032 48.9106 42.1342 47.9133 42.5962 47.2239C43.0582 46.5346 43.7659 46.1899 44.7192 46.1899C45.0932 46.1899 45.4196 46.2413 45.6982 46.3439C45.9842 46.4466 46.2262 46.5859 46.4242 46.7619C46.6222 46.9306 46.7872 47.1323 46.9192 47.3669C47.0512 47.5943 47.1576 47.8363 47.2382 48.0929L46.1272 48.4669C46.0686 48.2983 46.0026 48.1406 45.9292 47.9939C45.8559 47.8399 45.7642 47.7043 45.6542 47.5869C45.5516 47.4696 45.4232 47.3779 45.2692 47.3119C45.1226 47.2459 44.9429 47.2129 44.7302 47.2129C44.1949 47.2129 43.8062 47.4219 43.5642 47.8399C43.3296 48.2506 43.2122 48.8079 43.2122 49.5119V50.7329C43.2122 51.0849 43.2379 51.4076 43.2892 51.7009C43.3406 51.9943 43.4249 52.2473 43.5422 52.4599C43.6669 52.6653 43.8246 52.8266 44.0152 52.9439C44.2132 53.0613 44.4516 53.1199 44.7302 53.1199C45.1776 53.1199 45.5186 52.9879 45.7532 52.7239C45.9952 52.4526 46.1162 52.1079 46.1162 51.6899V50.9969H44.6312V50.0729H47.2382V53.9999H46.1162V52.9439Z" fill="#FAFAFA"/>
<path d="M60.3076 52.9439H60.2306C60.1646 53.0979 60.084 53.2483 59.9886 53.3949C59.9006 53.5343 59.787 53.6589 59.6476 53.7689C59.5156 53.8789 59.3543 53.9669 59.1636 54.0329C58.973 54.0989 58.753 54.1319 58.5036 54.1319C57.7043 54.1319 57.103 53.7909 56.6996 53.1089C56.2963 52.4269 56.0946 51.4626 56.0946 50.2159C56.0946 48.9106 56.3256 47.9133 56.7876 47.2239C57.2496 46.5346 57.9573 46.1899 58.9106 46.1899C59.2846 46.1899 59.611 46.2413 59.8896 46.3439C60.1756 46.4466 60.4176 46.5859 60.6156 46.7619C60.8136 46.9306 60.9786 47.1323 61.1106 47.3669C61.2426 47.5943 61.349 47.8363 61.4296 48.0929L60.3186 48.4669C60.26 48.2983 60.194 48.1406 60.1206 47.9939C60.0473 47.8399 59.9556 47.7043 59.8456 47.5869C59.743 47.4696 59.6146 47.3779 59.4606 47.3119C59.314 47.2459 59.1343 47.2129 58.9216 47.2129C58.3863 47.2129 57.9976 47.4219 57.7556 47.8399C57.521 48.2506 57.4036 48.8079 57.4036 49.5119V50.7329C57.4036 51.0849 57.4293 51.4076 57.4806 51.7009C57.532 51.9943 57.6163 52.2473 57.7336 52.4599C57.8583 52.6653 58.016 52.8266 58.2066 52.9439C58.4046 53.0613 58.643 53.1199 58.9216 53.1199C59.369 53.1199 59.71 52.9879 59.9446 52.7239C60.1866 52.4526 60.3076 52.1079 60.3076 51.6899V50.9969H58.8226V50.0729H61.4296V53.9999H60.3076V52.9439Z" fill="#FAFAFA"/>
<path d="M63.8613 53.9999V46.3219H65.0933V52.9659H68.5913V53.9999H63.8613Z" fill="#FAFAFA"/>
<path d="M74.851 53.9999L74.268 51.9539H71.826L71.243 53.9999H69.989L72.233 46.3219H73.916L76.16 53.9999H74.851ZM73.091 47.5649H73.003L72.057 50.9309H74.037L73.091 47.5649Z" fill="#FAFAFA"/>
<path d="M80.0987 54.1319C79.4314 54.1319 78.8704 54.0146 78.4157 53.7799C77.9611 53.5453 77.5871 53.2336 77.2937 52.8449L78.0857 52.0859C78.3791 52.4379 78.6907 52.6983 79.0207 52.8669C79.3507 53.0283 79.7247 53.1089 80.1427 53.1089C80.6267 53.1089 80.9971 52.9989 81.2537 52.7789C81.5177 52.5589 81.6497 52.2436 81.6497 51.8329C81.6497 51.5029 81.5544 51.2499 81.3637 51.0739C81.1731 50.8906 80.8467 50.7586 80.3847 50.6779L79.5487 50.5459C79.1821 50.4873 78.8741 50.3919 78.6247 50.2599C78.3754 50.1206 78.1737 49.9593 78.0197 49.7759C77.8657 49.5853 77.7521 49.3763 77.6787 49.1489C77.6127 48.9143 77.5797 48.6686 77.5797 48.4119C77.5797 47.6859 77.8144 47.1359 78.2837 46.7619C78.7531 46.3806 79.3984 46.1899 80.2197 46.1899C80.8284 46.1899 81.3454 46.2889 81.7707 46.4869C82.2034 46.6776 82.5517 46.9489 82.8157 47.3009L82.0457 48.0709C81.8331 47.8143 81.5801 47.6089 81.2867 47.4549C81.0007 47.2936 80.6451 47.2129 80.2197 47.2129C79.7651 47.2129 79.4167 47.3119 79.1747 47.5099C78.9401 47.7006 78.8227 47.9829 78.8227 48.3569C78.8227 48.6723 78.9144 48.9216 79.0977 49.1049C79.2884 49.2809 79.6221 49.4093 80.0987 49.4899L80.9127 49.6329C81.6021 49.7576 82.1044 50.0106 82.4197 50.3919C82.7351 50.7659 82.8927 51.2243 82.8927 51.7669C82.8927 52.1189 82.8304 52.4416 82.7057 52.7349C82.5884 53.0283 82.4087 53.2776 82.1667 53.4829C81.9321 53.6883 81.6387 53.8496 81.2867 53.9669C80.9421 54.0769 80.5461 54.1319 80.0987 54.1319Z" fill="#FAFAFA"/>
<path d="M87.1944 54.1319C86.5271 54.1319 85.9661 54.0146 85.5114 53.7799C85.0568 53.5453 84.6828 53.2336 84.3894 52.8449L85.1814 52.0859C85.4748 52.4379 85.7864 52.6983 86.1164 52.8669C86.4464 53.0283 86.8204 53.1089 87.2384 53.1089C87.7224 53.1089 88.0928 52.9989 88.3494 52.7789C88.6134 52.5589 88.7454 52.2436 88.7454 51.8329C88.7454 51.5029 88.6501 51.2499 88.4594 51.0739C88.2688 50.8906 87.9424 50.7586 87.4804 50.6779L86.6444 50.5459C86.2778 50.4873 85.9698 50.3919 85.7204 50.2599C85.4711 50.1206 85.2694 49.9593 85.1154 49.7759C84.9614 49.5853 84.8478 49.3763 84.7744 49.1489C84.7084 48.9143 84.6754 48.6686 84.6754 48.4119C84.6754 47.6859 84.9101 47.1359 85.3794 46.7619C85.8488 46.3806 86.4941 46.1899 87.3154 46.1899C87.9241 46.1899 88.4411 46.2889 88.8664 46.4869C89.2991 46.6776 89.6474 46.9489 89.9114 47.3009L89.1414 48.0709C88.9288 47.8143 88.6758 47.6089 88.3824 47.4549C88.0964 47.2936 87.7408 47.2129 87.3154 47.2129C86.8608 47.2129 86.5124 47.3119 86.2704 47.5099C86.0358 47.7006 85.9184 47.9829 85.9184 48.3569C85.9184 48.6723 86.0101 48.9216 86.1934 49.1049C86.3841 49.2809 86.7178 49.4093 87.1944 49.4899L88.0084 49.6329C88.6978 49.7576 89.2001 50.0106 89.5154 50.3919C89.8308 50.7659 89.9884 51.2243 89.9884 51.7669C89.9884 52.1189 89.9261 52.4416 89.8014 52.7349C89.6841 53.0283 89.5044 53.2776 89.2624 53.4829C89.0278 53.6883 88.7344 53.8496 88.3824 53.9669C88.0378 54.0769 87.6418 54.1319 87.1944 54.1319Z" fill="#FAFAFA"/>
<defs>
<linearGradient id="paint0_linear_414_27" x1="54.8636" y1="22.3685" x2="34.4207" y2="22.2482" gradientUnits="userSpaceOnUse">
<stop stop-color="#0069B4"/>
<stop offset="1" stop-color="#00B7CE"/>
</linearGradient>
<radialGradient id="paint1_radial_414_27" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(54.8637 22.5866) rotate(180) scale(20.5632 85.0441)">
<stop stop-color="#A055FA"/>
<stop offset="1" stop-color="#5800FA"/>
</radialGradient>
</defs>
</svg>`;

        let blob = new Blob([logo], {type: 'image/svg+xml'});
        let url = URL.createObjectURL(blob);
        let image = document.createElement('img');
        image.src = url;
        image.addEventListener('load', () => URL.revokeObjectURL(url), {once: true});
        image.width = 110;
        return image;
    }
}